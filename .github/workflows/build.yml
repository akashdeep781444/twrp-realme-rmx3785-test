name: Build TWRP for realme RMX3785

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y \
            git python3 python3-pip curl wget unzip zip \
            openjdk-11-jdk ccache bc rsync \
            build-essential libc6-dev-i386 lib32z1 \
            zlib1g-dev libssl-dev libxml2-utils xsltproc \
            cpio lz4
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        
    - name: Install repo tool
      run: |
        sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        sudo chmod a+x /usr/local/bin/repo
        
    - name: Initialize TWRP
      run: |
        mkdir twrp && cd twrp
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1
        
    - name: Sync sources
      run: |
        cd twrp
        repo sync -c -j4 --force-sync --no-clone-bundle --no-tags
        
    - name: Create device tree
      run: |
        mkdir -p twrp/device/realme/RE5C6CL1
        
        # Copy ALL files from your device tree
        cp -r ../device/realme/RE5C6CL1/* twrp/device/realme/RE5C6CL1/
        
        # Create prebuilt directory if it doesn't exist
        mkdir -p twrp/device/realme/RE5C6CL1/prebuilt
        
    - name: Download kernel and ramdisk
      run: |
        cd twrp/device/realme/RE5C6CL1/prebuilt
        
        # Install gdown for Google Drive
        pip install gdown
        
        # Download kernel - REPLACE WITH YOUR FILE ID
        gdown "https://drive.google.com/uc?id=1jZHwXptEP2YjM0PBDsbXNyPyRG3bkVuW" -O kernel
        
        # Download ramdisk - REPLACE WITH YOUR FILE ID  
        gdown "https://drive.google.com/uc?id=1FGDDKLzjAeCqTjnqQQhTivWOolWcoKgc" -O ramdisk.cpio
        
        echo "Files in prebuilt:"
        ls -lh
        
    - name: Fix device tree paths
      run: |
        cd twrp/device/realme/RE5C6CL1
        
        # Fix device.mk inheritance if needed
        if ! grep -q "LOCAL_PATH" device.mk 2>/dev/null; then
            echo "Fixing device.mk..."
            sed -i '1iLOCAL_PATH := \$(call my-dir)' device.mk
        fi
        
    - name: Build recovery
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch twrp_RE5C6CL1-eng
        mka recoveryimage
        
    - name: Upload recovery
      uses: actions/upload-artifact@v4
      with:
        name: recovery
        path: twrp/out/target/product/RE5C6CL1/recovery.img
