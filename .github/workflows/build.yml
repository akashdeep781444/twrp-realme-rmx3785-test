name: Build TWRP

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download files
      run: |
        mkdir -p device/realme/RE5C6CL1/prebuilt
        
        # Simple wget with retry
        wget --tries=3 --timeout=30 \
          "https://drive.google.com/uc?export=download&id=1jZHwXptEP2YjM0PBDsbXNyPyRG3bkVuW" \
          -O device/realme/RE5C6CL1/prebuilt/kernel
        
        wget --tries=3 --timeout=30 \
          "https://drive.google.com/uc?export=download&id=1FGDDKLzjAeCqTjnqQQhTivWOolWcoKgc" \
          -O device/realme/RE5C6CL1/prebuilt/ramdisk.cpio
        
    - name: Build
      run: |
        # Use pre-built Docker image with everything
        docker run --rm -v $(pwd):/src \
          lineageos4microg/docker-lineage-cicd:latest \
          bash -c "cd /src && \
          git clone https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1 twrp && \
          cd twrp && \
          cp -r /src/device/realme/RE5C6CL1 device/realme/ && \
          source build/envsetup.sh && \
          lunch twrp_RE5C6CL1-eng && \
          make recoveryimage"
          
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: recovery
        path: twrp/out/target/product/RE5C6CL1/recovery.img
