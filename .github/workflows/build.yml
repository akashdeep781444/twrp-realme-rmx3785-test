name: Build TWRP

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y git python3 wget openjdk-11-jdk
        sudo ln -s /usr/bin/python3 /usr/bin/python
        
    - name: Download prebuilts
      run: |
        mkdir -p device/realme/RE5C6CL1/prebuilt
        
        # Function to download from Google Drive
        download_gdrive() {
            fileid=$1
            filename=$2
            
            # First request to get confirmation token
            curl -c cookies.txt -s -L "https://drive.google.com/uc?export=download&id=$fileid" > /dev/null
            confirm=$(awk '/confirm/ {print $NF}' cookies.txt)
            
            # Download with confirmation
            curl -L -b cookies.txt "https://drive.google.com/uc?export=download&confirm=${confirm}&id=$fileid" -o "$filename"
            rm -f cookies.txt
        }
        
        # Download kernel
        echo "Downloading kernel..."
        download_gdrive "1jZHwXptEP2YjM0PBDsbXNyPyRG3bkVuW" "device/realme/RE5C6CL1/prebuilt/kernel"
        
        # Download ramdisk
        echo "Downloading ramdisk..."
        download_gdrive "1FGDDKLzjAeCqTjnqQQhTivWOolWcoKgc" "device/realme/RE5C6CL1/prebuilt/ramdisk.cpio"
        
        echo "Files:"
        ls -lh device/realme/RE5C6CL1/prebuilt/
        
    - name: Build with TWRP-Builder
      uses: Droid-Builders/TWRP-Builder@main
      with:
        device: RE5C6CL1
        brand: realme
        twrp_version: 12.1
